{% extends "base.html" %}

{% block title %}ç”Ÿæˆå‚æ•°é…ç½® - LLMjuice PDFæ–‡çŒ®å¤„ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>é—®ç­”å¯¹ç”Ÿæˆå‚æ•°é…ç½®
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    ç®€åŒ–ç‰ˆé…ç½®ï¼šä¸»è¦è°ƒæ•´ç”Ÿæˆæ•°é‡å’Œå¹¶å‘æ•°ã€‚å…¶ä»–å‚æ•°å°†ä½¿ç”¨å›ºå®šå€¼ä»¥ä¿æŒç¨³å®šã€‚
                </div>

                <form method="POST" id="generation-config-form">
                    <!-- å¹¶å‘æ§åˆ¶é…ç½® -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-rocket me-2"></i>å¹¶å‘æ§åˆ¶
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="max_requests_per_minute" class="form-label">
                                    æœ€å¤§è¯·æ±‚æ•°/åˆ†é’Ÿ <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="max_requests_per_minute"
                                       name="max_requests_per_minute" value="{{ params.max_requests_per_minute }}"
                                       min="1" max="1000" required>
                                <div class="form-text">
                                    æ¯åˆ†é’Ÿæœ€å¤§APIè¯·æ±‚æ•°ï¼Œé»˜è®¤ä¸º30ã€‚å»ºè®®æ ¹æ®APIæœåŠ¡å•†é™åˆ¶è°ƒæ•´ã€‚
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="setConcurrency(10)">
                                        <i class="fas fa-turtle me-1"></i>ä½é€Ÿ (10)
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="setConcurrency(30)">
                                        <i class="fas fa-play me-1"></i>æ ‡å‡† (30)
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="setConcurrency(100)">
                                        <i class="fas fa-rocket me-1"></i>é«˜é€Ÿ (100)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿæˆæ•°é‡é…ç½® -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-comments me-2"></i>ç”Ÿæˆæ•°é‡
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- æ•°é‡æ¨¡å¼é€‰æ‹© -->
                            <div class="mb-3">
                                <label class="form-label">
                                    ç”Ÿæˆæ¨¡å¼ <span class="text-danger">*</span>
                                </label>
                                <div class="btn-group w-100" role="group" aria-label="ç”Ÿæˆæ¨¡å¼é€‰æ‹©">
                                    <input type="radio" class="btn-check" name="generation_mode" id="manual_mode" value="manual"
                                           {% if params.generation_mode != 'auto' %}checked{% endif %} onchange="toggleGenerationMode()">
                                    <label class="btn btn-outline-primary" for="manual_mode">
                                        <i class="fas fa-edit me-1"></i>æ‰‹åŠ¨æŒ‡å®šæ•°é‡
                                    </label>

                                    <input type="radio" class="btn-check" name="generation_mode" id="auto_mode" value="auto"
                                           {% if params.generation_mode == 'auto' %}checked{% endif %} onchange="toggleGenerationMode()">
                                    <label class="btn btn-outline-success" for="auto_mode">
                                        <i class="fas fa-magic me-1"></i>è‡ªåŠ¨æœ€å¤§åŒ–
                                    </label>
                                </div>
                                <div class="form-text">
                                    é€‰æ‹©ç”Ÿæˆæ¨¡å¼ï¼šæ‰‹åŠ¨æŒ‡å®šæ•°é‡æˆ–è‡ªåŠ¨æœ€å¤§åŒ–åˆ°æ–‡ä»¶å…è®¸çš„æœ€å¤§å€¼ã€‚
                                </div>
                            </div>

                            <!-- æ‰‹åŠ¨æŒ‡å®šæ•°é‡ -->
                            <div class="mb-3" id="manual_count_section">
                                <label for="num_chat_to_generate" class="form-label">
                                    ç”Ÿæˆé—®ç­”å¯¹æ•°é‡ <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="num_chat_to_generate"
                                           name="num_chat_to_generate" value="{{ params.current_max_chat_to_generate if params.num_chat_to_generate == -1 else params.num_chat_to_generate }}"
                                           min="1" max="{{ params.current_max_chat_to_generate }}"
                                           {% if params.generation_mode == 'auto' %}disabled{% endif %} required>
                                    <span class="input-group-text">/ {{ params.current_max_chat_to_generate }} (å½“å‰åˆ‡ç‰‡æ•°)</span>
                                </div>
                                <div class="form-text">
                                    {{ params.display_text }}ã€‚æ‰‹åŠ¨æ¨¡å¼æŒ‡å®šæ•°é‡å°†åŸºäºå½“å‰å®é™…åˆ‡ç‰‡æ•°ã€‚
                                </div>
                            </div>

                            <!-- è‡ªåŠ¨æœ€å¤§åŒ–æ˜¾ç¤º -->
                            <div class="mb-3 d-none" id="auto_count_section">
                                <label class="form-label">
                                    è‡ªåŠ¨ç”Ÿæˆæ•°é‡
                                </label>
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>å°†è‡ªåŠ¨å¤„ç†æ‰€æœ‰åˆ‡ç‰‡ç”Ÿæˆé—®ç­”å¯¹</strong><br>
                                    <small>å½“å‰å·²æœ‰åˆ‡ç‰‡æ•°: {{ params.current_max_chat_to_generate }} ä¸ª</small><br>
                                    <small class="text-muted">ç³»ç»Ÿä¼šæ ¹æ®ä¸Šä¼ æ–‡ä»¶åçš„å®é™…åˆ‡ç‰‡æ•°é‡åŠ¨æ€ç”Ÿæˆç›¸åº”æ•°é‡çš„é—®ç­”å¯¹</small>
                                </div>
                            </div>

                            <!-- å¿«æ·è®¾ç½®æŒ‰é’®ï¼ˆä»…æ‰‹åŠ¨æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                            <div id="quick_buttons" class="row">
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="setMaxCount()"
                                            {% if params.generation_mode == 'auto' %}disabled{% endif %}>
                                        <i class="fas fa-arrows-alt me-1"></i>å…¨éƒ¨ ({{ params.current_max_chat_to_generate }})
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="setHalfCount()"
                                            {% if params.generation_mode == 'auto' %}disabled{% endif %}>
                                        <i class="fas fa-cut me-1"></i>ä¸€åŠ ({{ (params.current_max_chat_to_generate // 2) }})
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="setQuarterCount()"
                                            {% if params.generation_mode == 'auto' %}disabled{% endif %}>
                                        <i class="fas fa-percentage me-1"></i>1/4 ({{ (params.current_max_chat_to_generate // 4) }})
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setSingleCount()"
                                            {% if params.generation_mode == 'auto' %}disabled{% endif %}>
                                        <i class="fas fa-hand-pointer me-1"></i>å•ä¸ªæµ‹è¯•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›ºå®šå‚æ•°æ˜¾ç¤º -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-lock me-2"></i>å›ºå®šå‚æ•° (ä¸å¯ä¿®æ”¹)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="config-item mb-2">
                                        <i class="fas fa-language me-1"></i>
                                        <span>ç”Ÿæˆè¯­è¨€:</span>
                                        <span class="badge bg-primary ms-1">ä¸­æ–‡ (zh)</span>
                                    </div>
                                    <div class="config-item mb-2">
                                        <i class="fas fa-comments me-1"></i>
                                        <span>å¯¹è¯è½®æ¬¡:</span>
                                        <span class="badge bg-success ms-1">1è½®å¯¹è¯</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="config-item mb-2">
                                        <i class="fas fa-file-text me-1"></i>
                                        <span>è¾“å…¥æ–‡ä»¶:</span>
                                        <span class="badge bg-info ms-1">processed_data.jsonl</span>
                                    </div>
                                    <div class="config-item mb-2">
                                        <i class="fas fa-download me-1"></i>
                                        <span>è¾“å‡ºæ–‡ä»¶:</span>
                                        <span class="badge bg-secondary ms-1">train_final.jsonl</span>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-light small mb-0">
                                <i class="fas fa-info-circle me-1"></i>
                                è¿™äº›å‚æ•°ä¿æŒå›ºå®šä»¥ç¡®ä¿ç”Ÿæˆè´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚
                            </div>
                        </div>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>è¿”å›ä¸»é¡µ
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>ä¿å­˜å‚æ•°
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>ä½¿ç”¨è¯´æ˜
                </h6>
            </div>
            <div class="card-body">
                <h6 class="text-primary">ğŸš€ å¿«é€Ÿå¼€å§‹</h6>
                <ol>
                    <li><strong>é¦–æ¬¡ä½¿ç”¨</strong>: ä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆæ ‡å‡†é€Ÿåº¦ï¼Œæœ€å¤§ç”Ÿæˆæ•°é‡ï¼‰</li>
                    <li><strong>ç½‘ç»œæ…¢</strong>: é€‰æ‹©ä½é€Ÿæ¨¡å¼ï¼Œå‡å°‘å¹¶å‘è¯·æ±‚æ•°</li>
                    <li><strong>APIé…é¢æœ‰é™</strong>: é€‰æ‹©å°‘é‡ç”Ÿæˆæ•°é‡ï¼Œå¦‚å•ä¸ªæµ‹è¯•</li>
                    <li><strong>å¤§é‡å¤„ç†</strong>: é€‰æ‹©é«˜é€Ÿæ¨¡å¼ï¼Œæœ€å¤§ç”Ÿæˆæ•°é‡</li>
                </ol>

                <h6 class="text-warning mt-3">âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                <ul>
                    <li>å¹¶å‘æ•°è¿‡é«˜å¯èƒ½è§¦å‘APIé™åˆ¶</li>
                    <li>ç”Ÿæˆæ•°é‡è¶Šå¤šï¼Œå¤„ç†æ—¶é—´è¶Šé•¿ï¼ŒAPIæˆæœ¬è¶Šé«˜</li>
                    <li>å»ºè®®å…ˆä½¿ç”¨å°‘é‡æ•°æ®æµ‹è¯•æ•ˆæœ</li>
                    <li>å›ºå®šå‚æ•°ç¡®ä¿ç”Ÿæˆè´¨é‡ä¸€è‡´</li>
                </ul>

                <h6 class="text-success mt-3">ğŸ’¡ æ€§èƒ½å»ºè®®</h6>
                <ul>
                    <li><strong>DeepSeek API</strong>: æ¨è30å¹¶å‘/åˆ†é’Ÿï¼Œç¨³å®šå¯é </li>
                    <li><strong>OpenAI API</strong>: å¯ä½¿ç”¨æ›´é«˜å¹¶å‘ï¼Œä½†éœ€æ³¨æ„é™åˆ¶</li>
                    <li><strong>å®¶åº­ç½‘ç»œ</strong>: å»ºè®®10å¹¶å‘/åˆ†é’Ÿï¼Œé¿å…è¶…æ—¶</li>
                    <li><strong>æœåŠ¡å™¨ç¯å¢ƒ</strong>: å¯ä½¿ç”¨100å¹¶å‘/åˆ†é’Ÿï¼Œæœ€å¤§åŒ–æ•ˆç‡</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // åˆå§‹åŒ–æ¨¡å¼çŠ¶æ€
    toggleGenerationMode();

    // åˆå§‹åŒ–æ˜¾ç¤º
    updateConfigInfo();
});

function setConcurrency(value) {
    $('#max_requests_per_minute').val(value);
    updateConfigInfo();
}

function toggleGenerationMode() {
    const isManual = $('#manual_mode').is(':checked');

    if (isManual) {
        // æ‰‹åŠ¨æ¨¡å¼
        $('#manual_count_section').removeClass('d-none');
        $('#auto_count_section').addClass('d-none');
        $('#num_chat_to_generate').prop('disabled', false).prop('required', true);
        $('#quick_buttons button').prop('disabled', false);
    } else {
        // è‡ªåŠ¨æ¨¡å¼
        $('#manual_count_section').addClass('d-none');
        $('#auto_count_section').removeClass('d-none');
        $('#num_chat_to_generate').prop('disabled', true).prop('required', false);
        $('#quick_buttons button').prop('disabled', true);
    }

    updateConfigInfo();
}

function setMaxCount() {
    const currentMax = {{ params.current_max_chat_to_generate }};
    $('#num_chat_to_generate').val(currentMax);
    updateConfigInfo();
}

function setHalfCount() {
    const currentMax = {{ params.current_max_chat_to_generate }};
    const half = Math.floor(currentMax / 2);
    $('#num_chat_to_generate').val(half > 0 ? half : 1);
    updateConfigInfo();
}

function setQuarterCount() {
    const currentMax = {{ params.current_max_chat_to_generate }};
    const quarter = Math.floor(currentMax / 4);
    $('#num_chat_to_generate').val(quarter > 0 ? quarter : 1);
    updateConfigInfo();
}

function setSingleCount() {
    $('#num_chat_to_generate').val(1);
    updateConfigInfo();
}

function updateConfigInfo() {
    const concurrency = $('#max_requests_per_minute').val();
    const isAutoMode = $('#auto_mode').is(':checked');
    const currentMax = {{ params.current_max_chat_to_generate }};

    let numChat, displayText, timeEstimate, estimatedCost, maxDisplay;

    if (isAutoMode) {
        // è‡ªåŠ¨æ¨¡å¼ï¼šå°†å¤„ç†æ‰€æœ‰åˆ‡ç‰‡
        numChat = currentMax > 0 ? currentMax : 10; // å¦‚æœå½“å‰æ²¡æœ‰åˆ‡ç‰‡ï¼Œå‡è®¾ä¼šæœ‰10ä¸ª
        displayText = `${numChat} (è‡ªåŠ¨å¤„ç†æ‰€æœ‰åˆ‡ç‰‡)`;
        maxDisplay = "åŠ¨æ€æœ€å¤§å€¼";
    } else {
        // æ‰‹åŠ¨æ¨¡å¼ä½¿ç”¨è¾“å…¥å€¼
        numChat = parseInt($('#num_chat_to_generate').val()) || 1;
        displayText = `${numChat} (æ‰‹åŠ¨æŒ‡å®š)`;
        maxDisplay = currentMax;
    }

    // ä¼°ç®—å¤„ç†æ—¶é—´ï¼ˆåŸºäºç»éªŒå€¼ï¼‰
    if (concurrency <= 10) {
        timeEstimate = numChat * 30; // 30ç§’/ä¸ª
    } else if (concurrency <= 30) {
        timeEstimate = numChat * 10; // 10ç§’/ä¸ª
    } else {
        timeEstimate = numChat * 5;  // 5ç§’/ä¸ª
    }

    // ä¼°ç®—APIæˆæœ¬ï¼ˆåŸºäºç»éªŒå€¼ï¼Œä»…ä¾›å‚è€ƒï¼‰
    estimatedCost = numChat * 0.001; // æ¯ä¸ªé—®ç­”å¯¹çº¦0.001å…ƒ

    // æ›´æ–°æç¤ºä¿¡æ¯
    const modeText = isAutoMode ? 'è‡ªåŠ¨æœ€å¤§åŒ–' : 'æ‰‹åŠ¨æŒ‡å®š';
    const currentSlicesText = currentMax > 0 ? `å½“å‰åˆ‡ç‰‡æ•°: ${currentMax}` : 'æš‚æ— åˆ‡ç‰‡æ•°æ®';
    const infoHtml = `
        <div id="config-preview" class="alert alert-info small">
            <i class="fas fa-chart-line me-1"></i>
            <strong>é…ç½®é¢„è§ˆ:</strong><br>
            å¹¶å‘æ•°: ${concurrency}/åˆ†é’Ÿ | ç”Ÿæˆæ¨¡å¼: ${modeText}<br>
            ${currentSlicesText} | ç”Ÿæˆæ•°é‡: ${displayText}<br>
            é¢„è®¡è€—æ—¶: ${formatTime(timeEstimate)} | é¢„ä¼°æˆæœ¬: Â¥${estimatedCost.toFixed(4)}
        </div>
    `;

    // å¦‚æœæœ‰æ˜¾ç¤ºé…ç½®ä¿¡æ¯çš„åœ°æ–¹ï¼Œæ›´æ–°å®ƒ
    if ($('#config-preview').length === 0) {
        $('#generation-config-form').prepend(infoHtml);
    } else {
        $('#config-preview').replaceWith(infoHtml);
    }
}

function formatTime(seconds) {
    if (seconds < 60) {
        return `${seconds}ç§’`;
    } else if (seconds < 3600) {
        return `${Math.floor(seconds / 60)}åˆ†${seconds % 60}ç§’`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}å°æ—¶${minutes}åˆ†`;
    }
}

// è¡¨å•æäº¤éªŒè¯
$('#generation-config-form').on('submit', function(e) {
    const isAutoMode = $('#auto_mode').is(':checked');
    const currentMax = {{ params.current_max_chat_to_generate }};
    const concurrency = parseInt($('#max_requests_per_minute').val());

    // éªŒè¯å¹¶å‘æ•°
    if (concurrency < 1 || concurrency > 1000) {
        alert('å¹¶å‘æ•°å¿…é¡»åœ¨1åˆ°1000ä¹‹é—´');
        e.preventDefault();
        return false;
    }

    // éªŒè¯ç”Ÿæˆæ•°é‡ï¼ˆä»…æ‰‹åŠ¨æ¨¡å¼éœ€è¦éªŒè¯ï¼‰
    let numChat, confirmText;
    if (isAutoMode) {
        numChat = -1; // è‡ªåŠ¨æ¨¡å¼ä½¿ç”¨ç‰¹æ®Šå€¼
        confirmText = 'è‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶çš„åˆ‡ç‰‡';
    } else {
        numChat = parseInt($('#num_chat_to_generate').val());
        if (isNaN(numChat) || numChat < 1) {
            alert('ç”Ÿæˆæ•°é‡å¿…é¡»è‡³å°‘ä¸º1');
            e.preventDefault();
            return false;
        }
        if (currentMax > 0 && numChat > currentMax) {
            alert(`ç”Ÿæˆæ•°é‡ä¸èƒ½è¶…è¿‡å½“å‰åˆ‡ç‰‡æ•° ${currentMax}`);
            e.preventDefault();
            return false;
        }
        confirmText = `${numChat} ä¸ªé—®ç­”å¯¹`;
    }

    // ç¡®è®¤å¯¹è¯æ¡†
    const modeText = isAutoMode ? 'è‡ªåŠ¨æœ€å¤§åŒ–' : 'æ‰‹åŠ¨æŒ‡å®š';
    const maxText = currentMax > 0 ? `/${currentMax}` : ' (åŠ¨æ€)';
    const confirmMsg = `ç¡®è®¤é…ç½®ï¼š\nå¹¶å‘æ•°: ${concurrency}/åˆ†é’Ÿ\nç”Ÿæˆæ¨¡å¼: ${modeText}\nå½“å‰åˆ‡ç‰‡æ•°: ${currentMax}\nç”Ÿæˆæ•°é‡: ${confirmText}${maxText}\n\næ˜¯å¦ä¿å­˜ï¼Ÿ`;

    if (!confirm(confirmMsg)) {
        e.preventDefault();
        return false;
    }

    return true;
});
</script>
{% endblock %}